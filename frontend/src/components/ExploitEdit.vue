<script setup lang="ts">
import { ref, watch, computed } from 'vue'
import { ElNotification, type UploadInstance, type UploadProps, type UploadRawFile, genFileId } from 'element-plus'
import { UploadFilled } from '@element-plus/icons-vue'
import CodeEditor from './CodeEditor.vue'
import OutputTable from './OutputTable.vue'

interface Exploit {
  id: number
  name: string
  filename: string
  environment: string
  command: string
  argv: string
  platform: string
  arch: string
  filter: string
  timeout: string
  times: number
  flag: string
  team: string
  code: string
}

const props = defineProps<{
  modelValue?: boolean
  exploit?: Exploit | null
  exploitId?: string
  isEditing: boolean
  standalone?: boolean
}>()

const emit = defineEmits(['update:modelValue', 'save-success', 'close'])

const dialogVisible = computed({
  get: () => props.modelValue ?? true,
  set: (value) => emit('update:modelValue', value)
})

// 如果standalone为true，则显示独立模式
const isStandalone = computed(() => props.standalone === true)

const form = ref({
  id: 0,
  name: '',
  filename: '',
  environment: '',
  command: '',
  argv: '{ipbucket_default}',
  platform: '',
  arch: '',
  filter: '',
  timeout: 15,
  times: 0,
  flag: '',
  team: 'UNDEFINED',
  code: 'import sys\nimport uuid\nip = "127.0.0.1"\nif len(sys.argv) == 2:\n    ip = sys.argv[1]\nprint(f"ip:{ip} \\nflag{{{str(uuid.uuid4())}}}")',
  code_language: 'python3',
  usePipreqs: false
})

const loading = ref(false)
const activeTab = ref('code') // 'code' or 'file'
const hasFile = ref(false)
const uploadRef = ref<UploadInstance>()
const tempCodeContent = ref('') // 临时存储代码内容

// 正确解码包含UTF-8字符的base64字符串
const decodeBase64UTF8 = (base64: string): string => {
  try {
    // 使用decodeURIComponent和escape来处理UTF-8字符
    return decodeURIComponent(escape(atob(base64)))
  } catch (error) {
    console.error('Base64解码失败:', error)
    // 如果解码失败，尝试直接使用atob
    try {
      return atob(base64)
    } catch (e) {
      return base64 // 如果都失败了，返回原始字符串
    }
  }
}

// 根据ID获取数据
const fetchExploitById = async (id: string) => {
  try {
    const response = await fetch(`/webui/exploit_get_by_id?id=${id}`, {
      method: 'GET'
    })
    
    const result = await response.json()
    
    if (result.message === 'success' && result.result) {
      return result.result
    } else {
      console.error('获取Exploit失败:', result.error)
      return null
    }
  } catch (error) {
    console.error('获取Exploit失败:', error)
    return null
  }
}

// 监听exploitId变化，获取数据
watch(() => props.exploitId, async (newId) => {
  if (newId && props.isEditing) {
    const exploit = await fetchExploitById(newId)
    if (exploit) {
      updateFormFromExploit(exploit)
    }
  }
}, { immediate: true })

// 监听exploit变化，更新表单
watch(() => props.exploit, (newExploit) => {
  if (newExploit) {
    updateFormFromExploit(newExploit)
  }
}, { immediate: true })

// 从Exploit数据更新表单的通用函数
const updateFormFromExploit = (exploit: Exploit) => {
  if (exploit) {
    form.value = {
      id: exploit.id || 0,
      name: exploit.name || '',
      filename: exploit.filename || '',
      environment: exploit.environment || '',
      command: exploit.command || '',
      argv: exploit.argv || '',
      platform: exploit.platform || '',
      arch: exploit.arch || '',
      filter: exploit.filter || '',
      timeout: parseInt(exploit.timeout) || 15,
      times: exploit.times !== undefined ? exploit.times : 0,
      flag: exploit.flag || '',
      team: exploit.team || 'UNDEFINED',
      code: exploit.code || '',
      code_language: 'python3',
      usePipreqs: false
    }
    
    // 处理环境变量，检查是否包含 auto_pipreqs=True
    if (form.value.environment) {
      // 检查是否包含 auto_pipreqs=True
      form.value.usePipreqs = form.value.environment.includes('auto_pipreqs=True')
      
      // 移除 auto_pipreqs=True; 字符串
      form.value.environment = form.value.environment
        .replace(/auto_pipreqs=True;/g, '')
        .replace(/;{2,}/g, ';') // 移除连续的分号
        .replace(/^;|;$/g, '') // 移除开头和结尾的分号
        .trim()
    }
    
    // 解析代码语言
    if (exploit.code && exploit.code.startsWith('data:code/')) {
      try {
        const parts = exploit.code.split(';base64,')
        if (parts.length === 2 && parts[0] && parts[1]) {
          const langPart = parts[0].split('/')
          if (langPart.length === 2 && langPart[1]) {
            // 先设置语言，再设置代码内容
            form.value.code_language = langPart[1]
          }
          
          // 解码base64
          const base64Code = parts[1]
          const decodedCode = decodeBase64UTF8(base64Code)
          form.value.code = decodedCode
          activeTab.value = 'code'
        }
      } catch (error) {
        console.error('Base64解码失败:', error)
        form.value.code = exploit.code
      }
    } else if (exploit.code) {
      // 普通代码内容，尝试从代码内容推断语言
      form.value.code = exploit.code
      activeTab.value = 'code'
      
      // 简单的语言推断逻辑
      if (exploit.code.includes('#!/usr/bin/env python2') || 
          exploit.code.includes('#!/usr/bin/python2')) {
        form.value.code_language = 'python2'
      } else if (exploit.code.includes('#!/usr/bin/env python3') || 
                 exploit.code.includes('#!/usr/bin/python3') ||
                 exploit.code.includes('print(')) {
        form.value.code_language = 'python3'
      } else if (exploit.code.includes('package main') || 
                 exploit.code.includes('func main()')) {
        form.value.code_language = 'golang'
      } else if (exploit.code.includes('#!/bin/bash') || 
                 exploit.code.includes('#!/usr/bin/env bash') ||
                 exploit.code.includes('echo ') ||
                 exploit.code.includes('$')) {
        form.value.code_language = 'bash'
      }
    } else if (exploit.command) {
      activeTab.value = 'command'
    }
  }
}

// 计算最终的environment值
const computedEnvironment = computed(() => {
  let env = form.value.environment
  if (form.value.usePipreqs) {
    if (env && !env.endsWith(';')) {
      env += ';'
    }
    env += 'auto_pipreqs=True;'
  }
  return env
})

// 编码代码为base64格式
const encodeCodeToBase64 = (code: string, language: string): string => {
  if (!code.trim()) return ''
  try {
    // 使用encodeURIComponent和unescape来正确处理UTF-8字符
    const base64Code = btoa(unescape(encodeURIComponent(code)))
    return `data:code/${language};base64,${base64Code}`
  } catch (error) {
    console.error('Base64编码失败:', error)
    // 如果编码失败，尝试直接使用btoa
    try {
      const base64Code = btoa(code)
      return `data:code/${language};base64,${base64Code}`
    } catch (e) {
      return code // 如果都失败了，返回原始字符串
    }
  }
}

// 保存Exploit
const saveExploit = async () => {
  if (!form.value.name.trim() && !hasFile.value && !form.value.code.trim()) {
    ElNotification({
      title: '验证失败',
      message: '请输入名称、上传文件或编写代码中的至少一项',
      type: 'error',
      position: 'bottom-right'
    })
    return
  }

  loading.value = true
  try {
    if (hasFile.value) {
      // 文件上传模式
      uploadRef.value?.submit()
    } else {
      // 代码模式
      const formData = new FormData()
      
      if (props.isEditing && form.value.id > 0) {
        formData.append('id', form.value.id.toString())
      }
      
      formData.append('name', form.value.name)
      formData.append('filename', form.value.filename)
      formData.append('environment', computedEnvironment.value)
      formData.append('command', form.value.command)
      formData.append('argv', form.value.argv)
      formData.append('platform', form.value.platform)
      formData.append('arch', form.value.arch)
      formData.append('filter', form.value.filter)
      formData.append('timeout', form.value.timeout.toString())
      formData.append('times', form.value.times.toString())
      formData.append('flag', form.value.flag)
      formData.append('team', form.value.team)
      
      // 处理代码
      if (form.value.code.trim()) {
        const encodedCode = encodeCodeToBase64(form.value.code, form.value.code_language)
        formData.append('code', encodedCode)
      }

      const response = await fetch('/webui/exploit', {
        method: 'POST',
        body: formData
      })
      
      const result = await response.json()
      console.log('保存结果:', result) // 调试信息
      
      if (result.message === 'success') {
        ElNotification({
          title: '保存成功',
          message: props.isEditing ? '执行脚本更新成功' : '执行脚本创建成功',
          type: 'success',
          position: 'bottom-right'
        })
        
        // 如果是新增且返回了ID，更新URL
        if (!props.isEditing && result.id) {
          const url = new URL(window.location.href)
          url.searchParams.set('exploit_id', result.id.toString())
          url.searchParams.delete('name') // 删除旧的name参数
          window.history.pushState({ path: url.href }, '', url.href)
          
          // 更新表单中的名称（如果返回了name）
          if (result.name) {
            form.value.name = result.name
          }
        }
        
        emit('save-success')
      } else {
        ElNotification({
          title: '保存失败',
          message: result.error || '保存失败',
          type: 'error',
          position: 'bottom-right'
        })
      }
    }
  } catch (error) {
    console.error('保存Exploit失败:', error)
    ElNotification({
      title: '保存失败',
      message: '网络错误，请稍后重试',
      type: 'error',
      position: 'bottom-right'
    })
  } finally {
    loading.value = false
  }
}

// 关闭编辑
const closeEdit = () => {
  if (isStandalone.value) {
    // 如果是独立模式，关闭整个tab
    emit('close')
  } else {
    // 如果是对话框模式，关闭对话框
    dialogVisible.value = false
  }
}

// 重置表单
const resetForm = () => {
  form.value = {
    id: 0,
    name: '',
    filename: '',
    environment: '',
    command: '',
    argv: '{ipbucket_default}',
    platform: '',
    arch: '',
    filter: '',
    timeout: 15,
    times: 0,
    flag: '',
    team: 'UNDEFINED',
    code: 'import sys\nimport uuid\nip = "127.0.0.1"\nif len(sys.argv) == 2:\n    ip = sys.argv[1]\nprint(f"ip:{ip} \\nflag{{{str(uuid.uuid4())}}}")',
    code_language: 'python3',
    usePipreqs: false
  }
  activeTab.value = 'code'
}

// 切换标签页
const switchTab = (tab: string) => {
  // 保存当前标签页的代码内容
  if (activeTab.value === 'code' && form.value.code) {
    // 将代码内容保存到临时变量，避免丢失
    tempCodeContent.value = form.value.code
  }
  
  activeTab.value = tab
  
  if (tab === 'file') {
    // 切换到文件上传时，不清空代码，而是保存到临时变量
    if (form.value.code) {
      tempCodeContent.value = form.value.code
    }
  } else if (tab === 'code') {
    // 切换到代码编辑时，恢复之前保存的代码
    if (tempCodeContent.value) {
      form.value.code = tempCodeContent.value
    }
    hasFile.value = false
    uploadRef.value?.clearFiles()
  }
}

// 文件上传相关函数
const beforeUpload: UploadProps['beforeUpload'] = (rawFile) => {
  let name = rawFile.name
  if (name.endsWith('.py') && name.endsWith('.zip') && name.endsWith('.tar')) {
    ElNotification({
      title: '上传失败',
      message: '只能上传Python文件或压缩文件！',
      type: 'error',
      position: 'bottom-right',
    })
    return false
  } else if (rawFile.size / 1024 / 1024 > 1024) {
    ElNotification({
      title: '上传失败',
      message: '文件大小不能超过1024MB！',
      type: 'error',
      position: 'bottom-right',
    })
    return false
  }
  return true
}

const handleExceed: UploadProps['onExceed'] = (files) => {
  uploadRef.value!.clearFiles()
  const file = files[0] as UploadRawFile
  file.uid = genFileId()
  uploadRef.value!.handleStart(file)
}

const fileChange: UploadProps['onChange'] = (file, files) => {
  hasFile.value = files.length > 0
  let name = file.name
  if (name.endsWith('.zip') || name.endsWith('.tar')) {
    // 压缩文件时默认启用pipreqs
    form.value.usePipreqs = true
  }
  
  // 如果是单个Python文件，自动读取内容到代码编辑器
  if (files.length === 1 && name.endsWith('.py')) {
    const reader = new FileReader()
    reader.onload = (e) => {
      const content = e.target?.result as string
      if (content) {
        form.value.code = content
        // 保存到临时变量，确保切换标签页时不会丢失
        tempCodeContent.value = content
      }
    }
    reader.readAsText(file.raw!)
  }
}

const fileRemove: UploadProps['onRemove'] = (file, files) => {
  hasFile.value = files.length > 0
  // 如果删除了所有文件，清理临时代码内容
  if (files.length === 0) {
    tempCodeContent.value = ''
  }
}

const success_notice = (res: any) => {
  console.log('文件上传结果:', res) // 调试信息
  ElNotification({
    title: '上传成功',
    message: res.message,
    type: 'success',
    position: 'bottom-right',
  })
  
  // 如果返回了ID，更新表单和URL
  if (res.id) {
    form.value.id = res.id
    
    // 更新URL（无论是新增还是编辑）
    const url = new URL(window.location.href)
    url.searchParams.set('exploit_id', res.id.toString())
    url.searchParams.delete('name') // 删除旧的name参数
    window.history.pushState({ path: url.href }, '', url.href)
    
    // 更新表单中的名称（如果返回了name）
    if (res.name) {
      form.value.name = res.name
    }
  }
  
  // 文件上传成功后重置文件状态
  if (hasFile.value) {
    hasFile.value = false
    uploadRef.value?.clearFiles()
  }
  
  emit('save-success')
}

const error_notice = () => {
  ElNotification({
    title: '上传失败',
    message: '服务器无法响应您的请求！',
    type: 'error',
    position: 'bottom-right',
  })
}
</script>

<template>
  <div v-if="isStandalone" class="standalone-edit">
      <div class="edit-header">
        <h2>{{ isEditing ? `${form.name || '未命名'} - 编辑执行脚本` : '新增执行脚本' }}</h2>
      </div>
    <div class="edit-content">
      <el-form :model="form" label-width="120px" :rules="{}">
        <div class="form-section">
          <h3>基本信息</h3>
          <el-row :gutter="20">
            <el-col :xs="24" :sm="12" :md="6" :lg="6" :xl="6">
              <el-form-item label="名称">
                <el-input
                  v-model="form.name"
                  placeholder="留空自动生成"
                  maxlength="255"
                />
              </el-form-item>
            </el-col>
            
            <el-col :xs="24" :sm="12" :md="6" :lg="6" :xl="6">
              <el-form-item label="文件名">
                <el-input
                  v-model="form.filename"
                  placeholder="脚本文件名"
                  maxlength="255"
                />
              </el-form-item>
            </el-col>
            
            <el-col :xs="24" :sm="12" :md="6" :lg="6" :xl="6">
              <el-form-item label="环境变量">
                <el-input
                  v-model="form.environment"
                  placeholder="环境变量设置"
                  maxlength="255"
                />
              </el-form-item>
            </el-col>
            
            <el-col :xs="24" :sm="12" :md="6" :lg="6" :xl="6">
              <el-form-item label="筛选条件">
                <el-input
                  v-model="form.filter"
                  placeholder="筛选条件"
                  maxlength="255"
                />
              </el-form-item>
            </el-col>
          </el-row>
          
          <el-row :gutter="20">
            <el-col :xs="24" :sm="12" :md="6" :lg="6" :xl="6">
              <!-- 
                ===== 依赖选择器 - 重要备注 =====
                设计意图：依赖字段应该与系统字段在同一行，但占用较小的宽度
                布局要求：
                1. 使用较小的响应式宽度 (md="6" lg="6" xl="6")
                2. 与系统字段在同一行显示
                3. 包含一个复选框用于"自动安装依赖"选项
                4. 绑定到 form.usePipreqs 字段
                
                注意：这个字段应该与系统字段保持在同一行，不要移动到其他位置！
              -->
              <el-form-item label="依赖">
                <el-checkbox v-model="form.usePipreqs">自动安装依赖</el-checkbox>
              </el-form-item>
            </el-col>
            
            <el-col :xs="24" :sm="12" :md="6" :lg="6" :xl="6">
              <el-form-item label="团队">
                <el-input
                  v-model="form.team"
                  placeholder="团队名称"
                  maxlength="255"
                />
              </el-form-item>
            </el-col>
            
            <el-col :xs="24" :sm="12" :md="6" :lg="6" :xl="6">
              <!-- 
                ===== 系统选择器 - 重要备注 =====
                设计意图：将"平台"和"架构"两个下拉框合并到一个格子内并排显示
                布局要求：
                1. 使用一个 el-form-item，label为"系统"，占用一个格子 (md="6")
                2. 内部使用 div.os-selectors 容器包含两个下拉框
                3. 左侧：平台选择器 (platform-selector) - 绑定 form.platform
                4. 右侧：架构选择器 (arch-selector) - 绑定 form.arch
                5. 两个下拉框在同一个格子内并排显示，通过CSS flex布局控制
                6. CSS样式：.os-selectors { display: flex; } 无间隔
                7. 每个下拉框使用 flex: 1 平均分配宽度
                
                关键要求：两个下拉框必须在同一个格子内并排显示，不要拆分成两个格子！
                这是用户明确要求的布局设计，请勿随意修改！
              -->
              <el-form-item label="系统">
                <div class="os-selectors">
                  <el-select v-model="form.platform" placeholder="平台" class="platform-selector">
                    <el-option label="全部" value="" />
                    <el-option label="Windows" value="windows" />
                    <el-option label="FreeBSD" value="freebsd" />
                    <el-option label="Linux" value="linux" />
                    <el-option label="macOS" value="darwin" />
                  </el-select>
                  <el-select v-model="form.arch" placeholder="架构" class="arch-selector">
                    <el-option label="全部" value="" />
                    <el-option label="x64" value="amd64" />
                    <el-option label="x86" value="386" />
                    <el-option label="ARM64" value="arm64" />
                  </el-select>
                </div>
              </el-form-item>
            </el-col>
            
            <el-col :xs="24" :sm="12" :md="6" :lg="6" :xl="6">
              <el-form-item label="超时时间">
                <el-input-number
                  v-model="form.timeout"
                  :min="1"
                  :max="3600"
                  style="width: 100%"
                />
                <div class="form-tip">超时时间（秒）</div>
              </el-form-item>
            </el-col>
          </el-row>
          
          <el-row :gutter="20">
            <el-col :xs="24" :sm="12" :md="12" :lg="12" :xl="12">
              <el-form-item label="执行次数">
                <el-input-number
                  v-model="form.times"
                  :min="-2"
                  :max="999"
                  style="width: 100%"
                />
                <div class="form-tip">-2: 无限, -1: 手动, >0: 指定次数</div>
              </el-form-item>
            </el-col>
            
            <el-col :xs="24" :sm="12" :md="12" :lg="12" :xl="12">
              <el-form-item label="Flag正则">
                <el-input
                  v-model="form.flag"
                  placeholder="Flag匹配正则"
                  maxlength="255"
                />
              </el-form-item>
            </el-col>
            
          </el-row>
          
          <el-row :gutter="20">
            <el-col :xs="24" :sm="12" :md="12" :lg="12" :xl="12">
              <el-form-item label="执行命令">
                <el-input
                  v-model="form.command"
                  placeholder="执行命令（如：python, bash等）"
                  maxlength="255"
                />
                <div class="form-tip">
                  指定执行脚本的命令，如：python, bash, node等
                </div>
              </el-form-item>
            </el-col>
            
            <el-col :xs="24" :sm="12" :md="12" :lg="12" :xl="12">
              <el-form-item label="命令参数">
                <el-input
                  v-model="form.argv"
                  placeholder="命令参数（如：-u, --version等）"
                  maxlength="255"
                />
                <div class="form-tip">
                  传递给命令的参数，如：-u, --version, -c等
                </div>
              </el-form-item>
            </el-col>
          </el-row>
          
        </div>
        
        <div class="form-section">
          <h3>执行方式</h3>
          <el-tabs v-model="activeTab" @tab-change="switchTab" type="card" class="execution-tabs">
            <el-tab-pane name="code" label="代码编辑">
              <CodeEditor
                v-model="form.code"
                :language="form.code_language"
                @update:language="(lang) => form.code_language = lang"
                placeholder="print('Hello world')"
              />
            </el-tab-pane>
            
            <el-tab-pane name="file" label="文件上传">
              <el-upload 
                class="upload-demo" 
                drag 
                action="/webui/exploit" 
                :auto-upload="false" 
                :data="form" 
                ref="uploadRef"
                :on-success="success_notice" 
                :before-upload="beforeUpload" 
                :on-exceed="handleExceed" 
                :on-change="fileChange"
                :on-error="error_notice" 
                :on-remove="fileRemove" 
                :multiple="false"
              >
                <el-icon class="el-icon--upload"><upload-filled /></el-icon>
                <div class="el-upload__text">
                  拖动文件到此处,或者<em>点击此处上传</em>
                </div>
              </el-upload>
            </el-tab-pane>
          </el-tabs>
        </div>
        
        <div class="form-section">
          <h3>执行结果</h3>
          <OutputTable :exploit-name="props.exploitId || props.exploit?.id?.toString()" />
        </div>
      </el-form>
      
      <div class="edit-footer">
        <el-button @click="closeEdit">关闭</el-button>
        <el-button type="primary" @click="saveExploit" :loading="loading">
          {{ isEditing ? '更新' : '创建' }}
        </el-button>
      </div>
    </div>
  </div>
</template>

<style scoped>
.form-tip {
  font-size: 12px;
  color: #909399;
  margin-top: 4px;
}

.dialog-footer {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

:deep(.el-dialog__body) {
  padding: 20px;
}

:deep(.el-form-item) {
  margin-bottom: 20px;
}

:deep(.el-form-item__label) {
  font-weight: 600;
  color: #606266;
}

/* 执行方式标签页样式 - 修复宽度问题 */
.execution-tabs {
  width: 100% !important;
  min-height: 400px;
}

.execution-tabs :deep(.el-tabs__content) {
  padding: 0;
  width: 100% !important;
  min-height: 400px;
}

.execution-tabs :deep(.el-tab-pane) {
  width: 100% !important;
  height: 100%;
  display: flex;
  flex-direction: column;
}

/* 确保 tabs 容器和内容区域充分利用宽度 */
.execution-tabs :deep(.el-tabs__header) {
  width: 100% !important;
}

.execution-tabs :deep(.el-tabs__nav-wrap) {
  width: 100% !important;
}

.execution-tabs :deep(.el-tabs__nav-scroll) {
  width: 100% !important;
}

/* 代码编辑器响应式样式 - 修复宽度限制 */
.execution-tabs :deep(.el-tab-pane .code-editor-container) {
  width: 100% !important;
  flex: 1;
  display: flex;
  flex-direction: column;
  border: 1px solid #e6e8eb;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  min-height: 400px;
}

.execution-tabs :deep(.el-tab-pane .code-editor-container .cm-editor) {
  flex: 1;
  width: 100% !important;
  min-height: 400px;
}

.execution-tabs :deep(.cm-editor) {
  width: 100% !important;
  min-height: 400px;
}

.execution-tabs :deep(.cm-scroller) {
  width: 100% !important;
  min-height: 400px;
}

/* 文件上传区域响应式样式 */
.execution-tabs :deep(.el-tab-pane .upload-demo) {
  width: 100% !important;
  min-height: 400px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

/* 响应式媒体查询 */
@media (max-width: 768px) {
  :deep(.el-tabs__content) {
    height: calc(100vh - 250px);
    min-height: 300px;
  }
}

@media (max-width: 480px) {
  :deep(.el-tabs__content) {
    height: calc(100vh - 200px);
    min-height: 250px;
  }
}

/* 独立编辑样式 */
.standalone-edit {
  background: #fff;
  border-radius: 6px;
  border: 1px solid #e6e8eb;
  box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
  overflow: hidden;
  width: 100%;
}

.edit-header {
  background: #f5f7fa;
  padding: 20px;
  border-bottom: 1px solid #e6e8eb;
}

.edit-header h2 {
  margin: 0;
  color: #303133;
  font-size: 18px;
  font-weight: 600;
}

.edit-content {
  padding: 20px;
}

.form-section {
  margin-bottom: 30px;
}

.form-section h3 {
  margin: 0 0 15px 0;
  padding: 10px 0;
  border-bottom: 1px solid #e6e8eb;
  color: #303133;
  font-size: 16px;
  font-weight: 600;
}

.form-section:last-child {
  margin-bottom: 0;
}

.edit-footer {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 20px;
  padding: 20px;
  border-top: 1px solid #e6e8eb;
  background: #fafafa;
}

/* 
  ===== OS选择器样式 - 重要备注 =====
  设计意图：让平台和架构两个下拉框在同一个格子内并排显示，无间隔
  布局说明：
  1. .os-selectors 使用 flex 布局，让两个下拉框水平排列
  2. 无gap，两个下拉框紧贴在一起
  3. align-items: center 垂直居中对齐
  4. 每个下拉框使用 flex: 1 平均分配可用宽度
  
  注意：这个样式确保两个下拉框在同一个格子内并排显示，无间隔！
  不要修改这个布局，这是用户明确要求的！
*/
.os-selectors {
  display: flex;
  align-items: center;
}

.platform-selector {
  flex: 1;
}

.arch-selector {
  flex: 1;
}

/* 代码编辑器高度 */
:deep(.cm-editor) {
  min-height: 400px;
}

:deep(.cm-scroller) {
  min-height: 400px;
}

/* 文件上传样式 */
.upload-demo {
  width: 100%;
  border-radius: 6px;
  cursor: pointer;
  box-sizing: border-box;
  padding: 20px 0;
  text-align: center;
  border: 2px dashed #dcdfe6;
  background: #fafafa;
}

.upload-demo:hover {
  border-color: #409eff;
  background: #f0f7ff;
}
</style>
