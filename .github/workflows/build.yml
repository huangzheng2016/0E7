name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'
        
    - name: Install libpcap-dev
      run: |
        sudo apt-get update
        sudo apt-get install -y libpcap-dev
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci --loglevel=error --fund=false
        
    - name: Build frontend
      run: |
        cd frontend
        npm run build
        
    - name: Get Go dependencies
      run: go mod download
      
    - name: Build for Linux AMD64
      run: |
        echo "Building for Linux AMD64..."
        echo "Go version: $(go version)"
        echo "CGO enabled: $CGO_ENABLED"
        CGO_ENABLED=1 go build -ldflags="-s -w" -o 0e7_linux_amd64 .
        if [ $? -ne 0 ]; then
          echo "Build failed"
          exit 1
        fi
        echo "Build completed successfully"
        ls -la 0e7_linux_amd64
        
    - name: Verify Linux binary
      run: |
        file 0e7_linux_amd64
        ldd 0e7_linux_amd64 || echo "Binary verification completed"
        
    - name: Create archive
      run: |
        tar -czf 0e7_linux_amd64.tar.gz 0e7_linux_amd64
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-amd64
        path: 0e7_linux_amd64.tar.gz

  build-darwin:
    runs-on: macos-latest
    
    strategy:
      matrix:
        include:
          - goarch: amd64
          - goarch: arm64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'
        
    - name: Install libpcap
      run: |
        brew install libpcap
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci --loglevel=error --fund=false
        
    - name: Build frontend
      run: |
        cd frontend
        npm run build
        
    - name: Get Go dependencies
      run: go mod download
      
    - name: Build for Darwin
      run: |
        echo "Building for Darwin ${{ matrix.goarch }}..."
        echo "Go version: $(go version)"
        echo "CGO enabled: $CGO_ENABLED"
        GOARCH=${{ matrix.goarch }} CGO_ENABLED=1 go build -ldflags="-s -w" -o 0e7_darwin_${{ matrix.goarch }} .
        if [ $? -ne 0 ]; then
          echo "Build failed"
          exit 1
        fi
        echo "Build completed successfully"
        ls -la 0e7_darwin_${{ matrix.goarch }}
        
    - name: Verify Darwin binary
      run: |
        file 0e7_darwin_${{ matrix.goarch }}
        otool -L 0e7_darwin_${{ matrix.goarch }} || echo "Binary verification completed"
        
    - name: Create archive
      run: |
        tar -czf 0e7_darwin_${{ matrix.goarch }}.tar.gz 0e7_darwin_${{ matrix.goarch }}
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: darwin-${{ matrix.goarch }}
        path: 0e7_darwin_${{ matrix.goarch }}.tar.gz

  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'
        
    - name: Install 7-Zip
      run: |
        Write-Host "Installing 7-Zip..."
        choco install 7zip -y
        Write-Host "7-Zip installed successfully"
        
    - name: Download WinPcap installer
      run: |
        Write-Host "Downloading Nmap 7.12 setup to extract WinPcap..."
        try {
          # Download Nmap 7.12 setup
          Invoke-WebRequest -Uri "https://nmap.org/dist/nmap-7.12-setup.exe" -OutFile "nmap-7.12-setup.exe" -TimeoutSec 300 -UseBasicParsing
          Write-Host "Nmap setup downloaded successfully"
          
          # Extract WinPcap from Nmap setup using 7-Zip
          Write-Host "Extracting WinPcap from Nmap setup..."
          & "C:\ProgramData\chocolatey\bin\7z.exe" e nmap-7.12-setup.exe winpcap-nmap-4.13.exe
          Write-Host "WinPcap extracted successfully using 7-Zip"
        } catch {
          Write-Host "WinPcap download/extraction failed: $($_.Exception.Message)"
          exit 1
        } finally {
          # Clean up
          if (Test-Path "nmap-7.12-setup.exe") { Remove-Item "nmap-7.12-setup.exe" -Force }
        }
        
    - name: Install WinPcap
      run: |
        # Check if WinPcap is already installed
        $winpcapInstalled = Get-WmiObject -Class Win32_Product | Where-Object {$_.Name -like "*WinPcap*"}
        if ($winpcapInstalled) {
          Write-Host "WinPcap is already installed. Version: $($winpcapInstalled.Version)"
        } else {
          if (Test-Path "winpcap-nmap-4.13.exe") {
            Write-Host "Installing WinPcap from downloaded installer..."
            $process = Start-Process -FilePath "winpcap-nmap-4.13.exe" -ArgumentList "/S", "/v/qn" -Wait -PassThru -NoNewWindow
            if ($process.ExitCode -eq 0) {
              Write-Host "WinPcap installed successfully from downloaded installer"
            } else {
              Write-Host "WinPcap installation failed with exit code: $($process.ExitCode)"
              # Try alternative installation method
              Start-Process -FilePath "winpcap-nmap-4.13.exe" -ArgumentList "/SILENT", "/NORESTART" -Wait
              Write-Host "WinPcap installation completed with alternative method"
            }
          } else {
            Write-Host "WinPcap installer not found, installation skipped"
            exit 1
          }
        }
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci --loglevel=error --fund=false
        
    - name: Build frontend
      run: |
        cd frontend
        npm run build
        
    - name: Get Go dependencies
      run: go mod download
      
    - name: Build for Windows AMD64
      run: |
        $env:CGO_ENABLED = "1"
        Write-Host "Building for Windows AMD64..."
        Write-Host "Go version: $(go version)"
        Write-Host "CGO enabled: $env:CGO_ENABLED"
        go build -ldflags="-s -w" -o 0e7_windows_amd64.exe .
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Build failed with exit code: $LASTEXITCODE"
          exit 1
        }
        Write-Host "Build completed successfully"
        Get-ChildItem 0e7_windows_amd64.exe | Format-Table Name, Length, LastWriteTime
        
    - name: Verify Windows binary
      run: |
        Write-Host "Verifying Windows binary..."
        Get-ItemProperty 0e7_windows_amd64.exe | Select-Object Name, Length, VersionInfo
        Write-Host "Binary verification completed"
        
    - name: Create archive
      run: |
        Compress-Archive -Path "0e7_windows_amd64.exe" -DestinationPath "0e7_windows_amd64.zip"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-amd64
        path: 0e7_windows_amd64.zip

  electron-mac:
    needs: build-darwin
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'

    - name: Download macOS amd64 binary
      uses: actions/download-artifact@v4
      with:
        name: darwin-amd64
        path: artifacts/darwin-amd64

    - name: Download macOS arm64 binary
      uses: actions/download-artifact@v4
      with:
        name: darwin-arm64
        path: artifacts/darwin-arm64

    - name: Extract binaries
      run: |
        tar -xzf artifacts/darwin-amd64/0e7_darwin_amd64.tar.gz
        tar -xzf artifacts/darwin-arm64/0e7_darwin_arm64.tar.gz

    - name: Build Electron (macOS)
      run: |
        chmod +x build-electron.sh 0e7_darwin_amd64 0e7_darwin_arm64
        ./build-electron.sh --platform mac --arch all --skip-backend
        # Remove blockmap files
        find electron/release -name "*.blockmap" -type f -delete 2>/dev/null || true

    - name: Upload Electron macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: electron-mac
        path: electron/release/**

  electron-linux:
    needs: build-linux
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'

    - name: Download Linux binary
      uses: actions/download-artifact@v4
      with:
        name: linux-amd64
        path: artifacts/linux-amd64

    - name: Extract binary
      run: |
        tar -xzf artifacts/linux-amd64/0e7_linux_amd64.tar.gz

    - name: Build Electron (Linux)
      run: |
        chmod +x build-electron.sh 0e7_linux_amd64
        ./build-electron.sh --platform linux --arch amd64 --skip-backend
        # Remove blockmap files
        find electron/release -name "*.blockmap" -type f -delete 2>/dev/null || true

    - name: Upload Electron Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: electron-linux
        path: electron/release/**

  electron-windows:
    needs: build-windows
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'

    - name: Download Windows binary
      uses: actions/download-artifact@v4
      with:
        name: windows-amd64
        path: artifacts/windows-amd64

    - name: Extract binary
      shell: pwsh
      run: |
        Expand-Archive -Path artifacts/windows-amd64/0e7_windows_amd64.zip -DestinationPath .

    - name: Build Electron (Windows)
      shell: bash
      run: |
        chmod +x build-electron.sh
        ./build-electron.sh --platform windows --arch amd64 --skip-backend
        # Remove blockmap files
        find electron/release -name "*.blockmap" -type f -delete 2>/dev/null || true

    - name: Upload Electron Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: electron-windows
        path: electron/release/**

  wails-linux:
    needs: build-linux
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'

    - name: Download Linux binary
      uses: actions/download-artifact@v4
      with:
        name: linux-amd64
        path: artifacts/linux-amd64

    - name: Extract binary
      run: |
        tar -xzf artifacts/linux-amd64/0e7_linux_amd64.tar.gz

    - name: Install Wails dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgtk-3-dev \
          libwebkit2gtk-4.0-dev \
          libayatana-appindicator3-dev \
          librsvg2-dev

    - name: Install Wails CLI
      run: |
        go install github.com/wailsapp/wails/v2/cmd/wails@latest

    - name: Build Wails (Linux)
      run: |
        chmod +x build-wails.sh 0e7_linux_amd64
        ./build-wails.sh --platform linux --arch amd64 --skip-backend

    - name: Package Wails Linux app
      run: |
        cd wails/build/bin
        if [ -f "0e7-desktop" ]; then
          tar -czf 0e7-wails_linux_amd64.tar.gz 0e7-desktop
          echo "Package created: 0e7-wails_linux_amd64.tar.gz"
        else
          echo "Error: Wails binary not found"
          exit 1
        fi

    - name: Upload Wails Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wails-linux-amd64
        path: wails/build/bin/0e7-wails_linux_amd64.tar.gz

  wails-mac:
    needs: build-darwin
    runs-on: macos-latest
    
    strategy:
      matrix:
        include:
          - goarch: amd64
            binary_name: 0e7_darwin_amd64
            artifact_name: darwin-amd64
            package_name: 0e7-wails_darwin_amd64.tar.gz
          - goarch: arm64
            binary_name: 0e7_darwin_arm64
            artifact_name: darwin-arm64
            package_name: 0e7-wails_darwin_arm64.tar.gz

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'

    - name: Download macOS binary
      uses: actions/download-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: artifacts/${{ matrix.artifact_name }}

    - name: Extract binary
      run: |
        tar -xzf artifacts/${{ matrix.artifact_name }}/0e7_${{ matrix.goarch == 'amd64' && 'darwin_amd64' || 'darwin_arm64' }}.tar.gz

    - name: Install Wails CLI
      run: |
        go install github.com/wailsapp/wails/v2/cmd/wails@latest

    - name: Build Wails (macOS ${{ matrix.goarch }})
      run: |
        chmod +x build-wails.sh ${{ matrix.binary_name }}
        ./build-wails.sh --platform mac --arch ${{ matrix.goarch }} --skip-backend

    - name: Package Wails macOS app
      run: |
        cd wails/build/bin
        if [ -d "0E7 Desktop.app" ]; then
          tar -czf ${{ matrix.package_name }} "0E7 Desktop.app"
          echo "Package created: ${{ matrix.package_name }}"
        else
          echo "Error: Wails app bundle not found"
          exit 1
        fi

    - name: Upload Wails macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wails-mac-${{ matrix.goarch }}
        path: wails/build/bin/${{ matrix.package_name }}

  wails-windows:
    needs: build-windows
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'

    - name: Download Windows binary
      uses: actions/download-artifact@v4
      with:
        name: windows-amd64
        path: artifacts/windows-amd64

    - name: Extract binary
      shell: pwsh
      run: |
        Expand-Archive -Path artifacts/windows-amd64/0e7_windows_amd64.zip -DestinationPath .

    - name: Install Wails CLI
      shell: bash
      run: |
        go install github.com/wailsapp/wails/v2/cmd/wails@latest

    - name: Build Wails (Windows)
      shell: bash
      run: |
        chmod +x build-wails.sh
        ./build-wails.sh --platform windows --arch amd64 --skip-backend

    - name: Package Wails Windows app
      shell: pwsh
      run: |
        cd wails/build/bin
        if (Test-Path "0e7-desktop.exe") {
          Compress-Archive -Path "0e7-desktop.exe" -DestinationPath "0e7-wails_windows_amd64.zip" -Force
          Write-Host "Package created: 0e7-wails_windows_amd64.zip"
        } else {
          Write-Host "Error: Wails binary not found"
          exit 1
        }

    - name: Upload Wails Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wails-windows-amd64
        path: wails/build/bin/0e7-wails_windows_amd64.zip

  release:
    needs: [build-linux, build-darwin, build-windows, electron-mac, electron-linux, electron-windows, wails-linux, wails-mac, wails-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.version
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Prepare release files
      run: |
        mkdir -p release
        mkdir -p release_temp
        
        # Copy individual platform archives to release
        find . \( -name "*.tar.gz" -o -name "*.zip" \) | while read file; do
          cp "$file" release/
        done

        # Copy Electron artifacts (exclude blockmap files)
        find . -type f -name "0e7_electron_*" ! -name "*.blockmap" | while read file; do
          cp "$file" release/
        done
        
        # Copy Wails artifacts
        find . -type f -name "0e7-wails_*" | while read file; do
          cp "$file" release/
        done
        
        # Extract all archives to get executables
        cd release_temp
        
        # Extract Linux AMD64
        if [ -f ../release/0e7_linux_amd64.tar.gz ]; then
          tar -xzf ../release/0e7_linux_amd64.tar.gz
        fi
        
        # Extract Darwin AMD64
        if [ -f ../release/0e7_darwin_amd64.tar.gz ]; then
          tar -xzf ../release/0e7_darwin_amd64.tar.gz
        fi
        
        # Extract Darwin ARM64
        if [ -f ../release/0e7_darwin_arm64.tar.gz ]; then
          tar -xzf ../release/0e7_darwin_arm64.tar.gz
        fi
        
        # Extract Windows AMD64
        if [ -f ../release/0e7_windows_amd64.zip ]; then
          unzip -q ../release/0e7_windows_amd64.zip
        fi
        
        # Create combined archive with all executables (not nested archives)
        # Collect all executable files
        ls -la
        # Build file list dynamically
        FILES=""
        [ -f 0e7_linux_amd64 ] && FILES="$FILES 0e7_linux_amd64"
        [ -f 0e7_darwin_amd64 ] && FILES="$FILES 0e7_darwin_amd64"
        [ -f 0e7_darwin_arm64 ] && FILES="$FILES 0e7_darwin_arm64"
        [ -f 0e7_windows_amd64.exe ] && FILES="$FILES 0e7_windows_amd64.exe"
        
        if [ -n "$FILES" ]; then
          tar -czf ../release/0e7_all_platforms.tar.gz $FILES
        else
          echo "Warning: No executable files found to create all_platforms archive"
        fi
        
        cd ..
        rm -rf release_temp
        
        ls -la release/
        
    - name: Get version
      id: get_version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="dev-$(date +%Y%m%d-%H%M%S)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: Release ${{ steps.get_version.outputs.version }}
        draft: false
        prerelease: false
        files: |
          release/*
        body: |
          ## 0E7 Security Tool Release ${{ steps.get_version.outputs.version }}
          
          ### Downloads
          - **Linux AMD64**: `0e7_linux_amd64.tar.gz`
          - **macOS AMD64**: `0e7_darwin_amd64.tar.gz`
          - **macOS ARM64**: `0e7_darwin_arm64.tar.gz`
          - **Windows AMD64**: `0e7_windows_amd64.zip`
          - **All Platforms**: `0e7_all_platforms.tar.gz`
          - **macOS Electron AMD64 (DMG)**: `0e7_electron_mac_amd64.dmg`
          - **macOS Electron ARM64 (DMG)**: `0e7_electron_mac_arm64.dmg`
          - **Linux Electron AMD64 (DEB)**: `0e7_electron_linux_amd64.deb`
          - **Windows Electron AMD64 (Installer)**: `0e7_electron_win_amd64.exe`
          - **Linux Wails AMD64**: `0e7-wails_linux_amd64.tar.gz`
          - **macOS Wails AMD64**: `0e7-wails_darwin_amd64.tar.gz`
          - **macOS Wails ARM64**: `0e7-wails_darwin_arm64.tar.gz`
          - **Windows Wails AMD64**: `0e7-wails_windows_amd64.zip`
          
          ### Installation
          1. Download the appropriate file for your platform
          2. Extract the archive
          3. Make the binary executable (Linux/macOS): `chmod +x 0e7_*`
          4. Run: `./0e7_*` (Linux/macOS) or `0e7_*.exe` (Windows)
          
          ### Dependencies
          - **Linux**: Requires libpcap-dev
          - **macOS**: Requires libpcap (via Homebrew)
          - **Windows**: Requires WinPcap or Npcap
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}